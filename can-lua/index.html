<!DOCTYPE html>
<html lang="vi">
<head>
  <!-- Charset & viewport -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Primary SEO -->
  <title>TÃ­nh cÃ¢n lÃºa</title>
  <link rel="canonical" href="https://hoangdoinet.github.io/can-lua/" />
  <link rel="alternate" href="https://hoangdoinet.github.io/can-lua/" hreflang="vi-VN" />
  <link rel="alternate" href="https://hoangdoinet.github.io/can-lua/" hreflang="x-default" />
  <meta name="description" content="á»¨ng dá»¥ng tÃ­nh cÃ¢n lÃºa: nháº­p nhanh báº£ng tÃ­nh 5Ã—5, tá»± tÃ­nh khá»‘i lÆ°á»£ng, trá»« bÃ¬ & thÃ nh tiá»n theo chá»§ lÃºa vÃ  ghe, xe. CÃ i Ä‘áº·t á»©ng dá»¥ng trÃªn Android vÃ  iOS, há»— trá»£ sao lÆ°u/khÃ´i phá»¥c dá»¯ liá»‡u." />
  <meta name="author" content="HoÃ ng Äá»£i" />
  <meta name="creator" content="HoÃ ng Äá»£i" />
  <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1" />
  <meta name="referrer" content="origin-when-cross-origin" />
  <meta name="format-detection" content="telephone=no, address=no, email=no" />
  <meta name="color-scheme" content="light" />

  <!-- Icons / Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/can-lua/icons/icon-32.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/can-lua/icons/icon-192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/can-lua/icons/apple-icon-180.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="/can-lua/icons/apple-icon-152.png" />

  <!-- PWA -->
  <link rel="manifest" href="/can-lua/manifest.webmanifest" />
  <meta name="theme-color" content="#22c55e" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="TÃ­nh cÃ¢n lÃºa" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="TÃ­nh cÃ¢n lÃºa" />
  <meta property="og:title" content="TÃ­nh cÃ¢n lÃºa" />
  <meta property="og:description" content="Nháº­p nhanh báº£ng tÃ­nh 5Ã—5, tá»± Ä‘á»™ng tÃ­nh khá»‘i lÆ°á»£ng, trá»« bÃ¬ & thÃ nh tiá»n. CÃ i Ä‘áº·t á»©ng dá»¥ng trÃªn Android vÃ  iOS dÃ¹ng offline, sao lÆ°u/khÃ´i phá»¥c dá»¯ liá»‡u." />
  <meta property="og:url" content="https://hoangdoinet.github.io/can-lua/" />
  <meta property="og:image" content="https://hoangdoinet.github.io/can-lua/icons/og-image-1200.png" />
  <meta property="og:image:secure_url" content="https://hoangdoinet.github.io/can-lua/icons/og-image-1200.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="1200" />
  <meta property="og:image:alt" content="Giao diá»‡n á»©ng dá»¥ng TÃ­nh cÃ¢n lÃºa" />
  <meta property="og:locale" content="vi_VN" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="TÃ­nh cÃ¢n lÃºa" />
  <meta name="twitter:description" content="Nháº­p nhanh báº£ng tÃ­nh 5Ã—5, tá»± Ä‘á»™ng tÃ­nh khá»‘i lÆ°á»£ng, trá»« bÃ¬ & thÃ nh tiá»n. CÃ i Ä‘áº·t trÃªn Android vÃ  iOS dÃ¹ng offline, cÃ³ sao lÆ°u/khÃ´i phá»¥c dá»¯ liá»‡u." />
  <meta name="twitter:image" content="https://hoangdoinet.github.io/can-lua/icons/og-image-1200.png" />
  <meta name="twitter:image:alt" content="Giao diá»‡n á»©ng dá»¥ng TÃ­nh cÃ¢n lÃºa" />

  <!-- JSON-LD: SoftwareApplication + WebSite -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "SoftwareApplication",
        "name": "TÃ­nh cÃ¢n lÃºa",
        "applicationCategory": "BusinessApplication",
        "operatingSystem": "Android,iOS,Web",
        "description": "á»¨ng dá»¥ng tÃ­nh cÃ¢n lÃºa: nháº­p nhanh báº£ng tÃ­nh 5Ã—5, tá»± tÃ­nh khá»‘i lÆ°á»£ng, trá»« bÃ¬ & thÃ nh tiá»n theo chá»§ lÃºa vÃ  ghe, xe. DÃ¹ng offline, cÃ³ sao lÆ°u/khÃ´i phá»¥c dá»¯ liá»‡u.",
        "inLanguage": "vi-VN",
        "url": "https://hoangdoinet.github.io/can-lua/",
        "image": "https://hoangdoinet.github.io/can-lua/icons/og-image-1200.png",
        "author": { "@type": "Person", "name": "HoÃ ng Äá»£i" },
        "offers": { "@type": "Offer", "price": "0", "priceCurrency": "VND", "category": "Free" },
        "softwareVersion": "1.0.3"
      },
      {
        "@type": "WebSite",
        "name": "TÃ­nh cÃ¢n lÃºa",
        "url": "https://hoangdoinet.github.io/can-lua/",
        "inLanguage": "vi-VN",
        "publisher": { "@type": "Person", "name": "HoÃ ng Äá»£i" }
      }
    ]
  }
  </script>

  <style>
    :root{
      --bg:#f7f9fc; --surface:#ffffff; --surface-2:#f3f4f6; --muted:#6b7280; --text:#111827;
      --accent:#22c55e; --accent-2:#16a34a; --accent-soft:#ecfdf5;
      --danger:#dc2626; --border:#e5e7eb;
      --ring:0 0 0 2px rgba(34,197,94,.28);
      --shadow:0 10px 28px rgba(2,6,23,.08);
      --radius:18px;
      --orange:#f59e0b; --orange-soft:#ffedd5; --orange-softer:#fff7ed;
      --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,#f8fafc,#f1f5f9 50%,#f8fafc);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif
    }
    .appbar{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding-top:var(--sat)}
    .appbar-inner{display:flex;align-items:center;gap:8px;padding:12px 14px}
    .app-title{font-size:18px;font-weight:800}
    .subtitle{font-size:12px;color:var(--muted)}
    .back{font-size:15px;font-weight:800;color: var(--accent);border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 10px}
    .back:hover {background: var(--accent-soft);color: var(--accent-2);}
    .section{margin:12px;background:#fff;border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
    .section-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px dashed var(--accent);background:var(--accent-soft)}
    .section-title{font-size:15px;font-weight:800}
    .section-body{padding:12px 14px}
    .list{display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:8px;align-items:center}
    input[type=text], input[type=number], input[type=tel], select{width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:#fff;color:#111827}
    input:focus, select:focus{outline:none;box-shadow:var(--ring)}
    button{border:0;border-radius:999px;padding:10px 14px;background:var(--accent-soft);color:#111827;cursor:pointer;border:1px solid var(--border)}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:none;font-weight:700}
    .btn-danger{background:linear-gradient(90deg,#ef4444,#b91c1c);color:#fff;border:none}
    .btn-ghost{background:#fff}
    .chip{font-size:12px;padding:6px 10px;border-radius:999px;background:#fff;border:1px solid var(--border);color:#6b7280}
    .group-card{border:1px solid var(--border);border-radius:16px;background:#fff;box-shadow:var(--shadow);overflow:hidden}
    .group-card .g-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px dashed var(--accent);background:var(--accent-soft)}
    .group-card .g-title{font-weight:800}
    .group-card .g-body{padding:12px}
    .group-card .fake-input{border:1px solid var(--border);border-radius:12px;background:#fff;padding:4px 0}
    .kv{display:flex;align-items:center;gap:8px;padding:10px 12px;font-weight:800}
    .kv + .kv{border-top:1px dashed #e6e9ee}
    .kv .label{flex:1}
    .kv .value{min-width:120px;text-align:right}
    .kv .value.danger{ color: var(--danger); font-weight: 800; }
    .kv .value.accent{ color: var(--accent); font-weight: 800; }
    .kv .value.orange{ color: var(--orange); font-weight: 800; }
    .group-card .g-foot{display:flex;gap:8px;justify-content:flex-end;padding:10px 12px;border-top:1px dashed #e6e9ee;background:#fafafa}
    .group-card .g-foot button{padding:8px 12px}
    .muted{color:var(--muted);font-size:12px}
    .table-card{border:1px solid var(--border);border-radius:16px;overflow:hidden;background:#fff;margin-bottom:12px}
    .table-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px dashed var(--border);background:var(--accent-soft)}
    .colheads{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:8px 12px 0 12px}
    .colheads span{display:block;text-align:center;font-weight:800;color:#16a34a}
    .cells{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:12px}
    .cells input{padding:14px 10px;text-align:center;border-radius:12px;border:1px solid var(--border);background:#fff;font-weight:800}
    .cells input[disabled]{background:#f1f5f9;color:#9ca3af}
    .cells input.warn{background:#fef3c7!important;color:#b91c1c!important;border-color:#f59e0b}
    .colTotals{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:0 12px 12px}
    .colTotals span{display:block;text-align:center;font-weight:800;border:1px dashed var(--accent);background:var(--accent-soft);border-radius:10px;padding:6px 0}
    .sum{display:flex;align-items:center;justify-content:center;padding:10px 12px;border-top:1px dashed #e6e9ee;color:#16a34a;font-weight:800}
    .fab{position:fixed;right:16px;bottom:16px;z-index:13;display:flex;flex-direction:column;gap:10px; padding-bottom:calc(16px + var(--sab));}
    .fab button{width:56px;height:56px;border-radius:999px;display:grid;place-items:center;font-size:20px;box-shadow:var(--shadow)}
    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);backdrop-filter:blur(2px);display:none;z-index:20}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top-left-radius:20px;border-top-right-radius:20px;box-shadow:var(--shadow);transform:translateY(110%);transition:transform .25s ease;z-index:21;border-top:1px solid var(--border)}
    .sheet-head{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .sheet-body{padding:14px 16px}
    .sheet-body .field{margin-bottom:10px}
    .sheet-body label{display:block;font-weight:800;font-size:12px;margin-bottom:6px;color:#374151}
    .sheet-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px dashed #e6e9ee}
    .sheet.open{transform:translateY(0)}
    .sheet-backdrop.open{display:block}
    .stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:8px 12px 12px 12px}
    .stat{background:#fff;border:1px solid var(--accent);border-radius:12px;padding:10px}
    .stat label{display:block;font-weight:800;font-size:12px;margin-bottom:6px}
    .stat input{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;font-weight:800}
    .stat input[readonly]{background:#f9fafb;color:#111827}
    .stat input.view3-danger{color:var(--danger)!important;font-weight:800; background: #fff8c2}
    .stat input.view3-orange{color:var(--orange)!important;font-weight:800; background: var(--accent-soft)}
    .stat input.view3-accent{color:var(--accent)!important;font-weight:800; background: var(--accent-soft)}
    .mode-section{border:1px dashed #e5e7eb;border-radius:12px;padding:10px;margin-top:8px}
    .mode-title{font-weight:800;margin-bottom:6px}
    .mode-option{display:flex;align-items:center;gap:8px;margin:4px 0}
    .dialog-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);display:none;z-index:40}
    .dialog{position:fixed;left:50%;top:50%;transform:translate(-50%, -50%) scale(.96);opacity:0;transition:.2s ease;z-index:41;width:min(92vw,440px);background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);display:none;}
    .dialog.open{display:block;transform:translate(-50%, -50%) scale(1);opacity:1}
    .dialog-head{padding:12px 16px;border-bottom:1px dashed #e6e9ee;background:#fafafa;font-weight:800}
    .dialog-body{padding:14px 16px;line-height:1.5}
    .dialog-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px dashed #e6e9ee}
    .tool-list{display:flex;flex-direction:column;gap:10px}
    .tool-item{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:14px;cursor:pointer}
    .tool-item:hover{background:#f9fafb}
    .tool-ico{font-size:20px;line-height:1.1}
    .tool-main{flex:1}
    .tool-title{font-weight:800}
    .tool-sub{font-size:12px;color:#6b7280}
    .tip-text{font-size:12px;color:#6b7280;margin-top:4px;font-style:italic;}
    .app-footer{margin:12px;padding:10px 14px;text-align:center;color:#6b7280;font-size:12px;}
    :root{ --brand1:#22c55e; --brand2:#16a34a; }
    #splash{position:fixed; inset:0; padding: calc(var(--sat, 0) + 16px) 16px calc(var(--sab, 0) + 16px);
      background: radial-gradient(120% 90% at 50% -10%, #fff3 0%, #0000 60%), linear-gradient(180deg,var(--brand1),var(--brand2));
      color:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999; text-align:center; transition:opacity .7s ease, visibility .7s;}
    #splash.hidden{ opacity:0; visibility:hidden; }
    .logo-wrap{ position:relative; width:140px; height:140px; filter:drop-shadow(0 10px 24px rgba(0,0,0,.28)); }
    .logo-img{ width:100%; height:100%; border-radius:24%; animation: popIn 900ms cubic-bezier(.2,.7,.2,1) both, glow 1.6s .9s ease-in-out 2 alternate; will-change: transform, filter; }
    .logo-wrap::after{ content:""; position:absolute; inset:-8%;
      background: linear-gradient(75deg, transparent 30%, #fff6 48%, #fff9 52%, transparent 70%);
      transform: translateX(-120%) rotate(8deg); border-radius:28%; animation: sweep 1.1s .35s ease-out forwards; pointer-events:none; mix-blend-mode:overlay; }
    .app-name{ margin-top:14px; font-size:26px; font-weight:800; letter-spacing:.8px; overflow:hidden; white-space:nowrap; border-right:2px solid rgba(255,255,255,.85);
      width:0; animation: typing 1.4s .45s steps(18,end) forwards, caret .9s step-end infinite; text-shadow: 0 1px 2px #0003; }
    .meta{ margin-top:8px; font-size:14px; opacity:.95 } .meta b{ font-weight:800 }
    @keyframes popIn{0%{ transform: scale(.6) rotate(-8deg); opacity:.0 }60%{ transform: scale(1.08) rotate(3deg); opacity:1 }100%{ transform: scale(1) rotate(0) }}
    @keyframes glow{from{ filter: drop-shadow(0 10px 24px rgba(0,0,0,.28)) brightness(1) saturate(1) }to{ filter: drop-shadow(0 12px 34px rgba(0,0,0,.35)) brightness(1.08) saturate(1.1) }}
    @keyframes sweep{ to{ transform: translateX(120%) rotate(8deg); opacity:.0 } }
    @keyframes typing{ from{ width:0 } to{ width:100% } }
    @keyframes caret{ 50%{ border-color: transparent } }
    @media (prefers-reduced-motion: reduce){ .logo-img, .logo-wrap::after, .app-name{ animation: none !important } #splash{ transition: opacity .2s ease, visibility .2s } }

    /* ==== Bá»” SUNG: Highlight Ã´ báº¯t buá»™c ==== */
    .input-invalid{ border-color: var(--danger) !important; background:#fee2e2 !important; }
    .required > label::after{ content:" *"; color: var(--danger); font-weight:800; }
  </style>
</head>
<body>

  <!-- ğŸŒ¾ Splash -->
  <div id="splash" role="status" aria-label="Äang khá»Ÿi Ä‘á»™ng á»©ng dá»¥ng">
    <div class="logo-wrap">
      <img src="/can-lua/icons/icon-512.png" class="logo-img" alt="Logo TÃ­nh CÃ¢n LÃºa" width="140" height="140">
    </div>
    <div class="app-name" aria-hidden="true">TÃNH CÃ‚N LÃšA</div>
    <div class="meta">PhiÃªn báº£n: <b id="verText">v1.0.3</b></div>
    <div class="meta">TÃ¡c giáº£: <b id="authorText">HoÃ ng Äá»£i</b></div>
  </div>

<div class="app">
  <div class="appbar">
    <div class="appbar-inner">
      <button type="button" class="back" id="btnBack" style="display:none" aria-label="Quay láº¡i">â†</button>
      <div style="flex:1">
        <h1 class="app-title" id="appTitle">TÃNH CÃ‚N LÃšA</h1>
        <div class="subtitle" id="appSub">á»¨ng dá»¥ng quáº£n lÃ½ cÃ¢n lÃºa</div>
      </div>
      <div class="row">
        <button type="button" class="btn-ghost" id="btnTools">ğŸ› ï¸ Tiá»‡n Ã­ch</button>
      </div>
    </div>
  </div>

  <!-- View 1 -->
  <div id="view-groups" class="section">
    <div class="section-head">
      <div class="section-title">Danh sÃ¡ch ghe, xe</div>
      <div class="row"><span class="chip" id="chipGroups">Ghe, xe: 0</span></div>
    </div>
    <div class="section-body"><div style="height:8px"></div><div id="groupList" class="list"></div></div>
  </div>

  <!-- View 2 -->
  <div id="view-farmers" class="section" style="display:none">
    <div class="section-head">
      <div class="section-title">TÃªn ghe, xe: <span id="chipGroupName">â€”</span></div>
      <div class="row"><span class="chip" id="chipFarmerCount">Chá»§ lÃºa: 0</span></div>
    </div>
    <div class="section-body">
      <div id="farmersStats" class="stat-grid">
        <div class="stat"><label><b>Sá»‘ bao (láº§n cÃ¢n):</b></label><input id="stat2Bags" class="view3-orange" type="text" readonly value="0"></div>
        <div class="stat"><label><b>Tá»•ng cÃ¢n (kg):</b></label><input id="stat2Kg" class="view3-orange" type="text" readonly value="0"></div>
      </div>
      <div id="farmerList" class="list"></div>
    </div>
  </div>

  <!-- View 3 -->
  <div id="view-tables" class="section" style="display:none">
    <div class="section-head"><div class="section-title title" id="contextTitle">Báº¢NG 5Ã—5</div></div>
    <div class="section-body"><div id="tables"></div></div>
  </div>

  <!-- FAB -->
  <div class="fab">
    <button type="button" id="fabAddFarmer" class="btn-primary" title="ThÃªm chá»§ lÃºa">ğŸ‘¤</button>
    <button type="button" id="fabAddGroup" class="btn-primary" title="ThÃªm ghe, xe">â•</button>
  </div>

  <input id="fileInput" type="file" accept="application/json" style="display:none">

  <!-- Bottom Sheet -->
  <div class="sheet-backdrop" id="sheetBackdrop"></div>
  <div class="sheet" id="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
    <div class="sheet-head">
      <div id="sheetTitle" style="font-weight:800">ThÃªm</div>
      <button type="button" class="btn-ghost" id="btnSheetClose">âœ•</button>
    </div>
    <div class="sheet-body" id="sheetBody"></div>
    <div class="sheet-actions">
      <button type="button" class="btn-ghost" id="btnSheetCancel">Há»§y</button>
      <button type="button" class="btn-primary" id="sheetConfirm">LÆ°u</button>
    </div>
  </div>

  <!-- Center Dialog -->
  <div class="dialog-backdrop" id="dlgBackdrop"></div>
  <div class="dialog" id="dialog" role="alertdialog" aria-labelledby="dlgTitle" aria-describedby="dlgBody">
    <div class="dialog-head" id="dlgTitle">ThÃ´ng bÃ¡o</div>
    <div class="dialog-body" id="dlgBody" aria-live="polite">Ná»™i dung</div>
    <div class="dialog-actions">
      <button type="button" class="btn-ghost" id="dlgCancel" style="display:none">Há»§y</button>
      <button type="button" class="btn-primary" id="dlgOk">OK</button>
    </div>
  </div>

  <!-- Footer -->
  <div class="app-footer">Â© 2025 â€” HoÃ ng Äá»£i</div>
</div> <!-- káº¿t thÃºc .app -->

<script>
/* ===== State & Utils ===== */
const APP_VERSION='v1.0.3';

/* ==== Splash Control (dÃ¹ng APP_VERSION) ==== */
(function(){
  const qs = sel => document.querySelector(sel);
  const verEl = qs('#verText'); if (verEl) verEl.textContent = APP_VERSION;
  const authorEl = qs('#authorText'); if (authorEl) authorEl.textContent = 'HoÃ ng Äá»£i';

  const hideSplash = () => {
    const el = document.getElementById('splash');
    if (!el || el.classList.contains('hidden')) return;
    el.classList.add('hidden'); document.body.classList.add('ready');
  };

  window.addEventListener('load', () => { setTimeout(hideSplash, 1800); });
  setTimeout(hideSplash, 3500);

  const _origRender = (typeof render==='function') ? render : null;
  if (_origRender){
    window.render = function(){
      _origRender.apply(this, arguments);
      setTimeout(hideSplash, 3000);
    };
  }
})();

const STORAGE_KEY='riceScaleData';
let state={groups:{},activeGroup:'',activeFarmer:'',view:'groups'};

const $=id=>document.getElementById(id);
const newEmptyTable=()=>Array.from({length:25},()=>null);
const fmt=n=> new Intl.NumberFormat('vi-VN').format(Math.round((+n||0)*100)/100);
const vnd=n=> new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND',maximumFractionDigits:0}).format(Math.round(+n||0));
function sumTable(arr){return arr.reduce((s,v)=>s+(typeof v==='number'?v:0),0)}
function sumCol(tbl,col){let s=0; for(let r=0;r<5;r++){const v=tbl[r*5+col]; if(typeof v==='number') s+=v;} return s;}
function isTableFull(arr){return arr.every(v=> typeof v==='number' && !isNaN(v))}
function escapeHtml(s){const map={"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};return String(s).replace(/[&<>"']/g,c=>map[c]);}
function pad2(x){return String(x).padStart(2,'0')}
function formatDateTimeDDMM_HHmm(ts){const d=new Date(ts||Date.now());return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} - ${pad2(d.getHours())}:${pad2(d.getMinutes())}`}
function byteLen(str){return new Blob([str]).size}
function formatBytes(b){ if (b<1024) return b+' B'; const kb=b/1024; if(kb<1024) return kb.toFixed(1)+' KB'; const mb=kb/1024; return mb.toFixed(2)+' MB'; }
function getActiveGroup(){return state.groups[state.activeGroup]||null}
function getActiveFarmer(){const g=getActiveGroup(); if(!g) return null; return g.farmers[state.activeFarmer]||null}
function labelInputMode(m){switch(m){case 'lt2':return '<100kg: 2 sá»‘';case 'lt3':return '<100kg: 3 sá»‘ (cháºµn)';case 'ge3':return 'â‰¥100kg: 3 sá»‘';case 'ge4':return 'â‰¥100kg: 4 sá»‘ (cháºµn)';default:return 'â€”';}}
function buildKV(label, value, valueClass=''){const line=document.createElement('div');line.className='kv';const l=document.createElement('div');l.className='label';l.textContent=label;const v=document.createElement('div'); v.className='value' + (valueClass?(' '+valueClass):''); v.textContent=value;line.appendChild(l);line.appendChild(v);return line;}

/* ===== Dialog ===== */
let _dlgOk=null,_dlgCancel=null;
function openDialog({title='ThÃ´ng bÃ¡o',message='',okText='OK',cancelText=null}={}){
  $('dlgTitle').textContent=title; $('dlgBody').innerHTML=message;
  const cancelBtn=$('dlgCancel'), okBtn=$('dlgOk');
  cancelBtn.style.display=cancelText?'inline-block':'none'; if(cancelText) cancelBtn.textContent=cancelText; okBtn.textContent=okText||'OK';
  $('dlgBackdrop').style.display='block'; $('dialog').classList.add('open');

  return new Promise(res=>{
    _dlgOk=()=>{ closeDialog(); res(true) };
    _dlgCancel=()=>{ closeDialog(); res(false) };

    okBtn.onclick=_dlgOk;
    cancelBtn.onclick=_dlgCancel;
    $('dlgBackdrop').onclick=_dlgCancel;
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') _dlgCancel(); },{once:true});
  });
}
function closeDialog(){ $('dlgBackdrop').style.display='none'; $('dialog').classList.remove('open'); _dlgOk=_dlgCancel=null; }
const showAlert=(msg,title='ThÃ´ng bÃ¡o')=>openDialog({title,message:msg,okText:'ÄÃ£ hiá»ƒu'});
const showConfirm=(msg,{title='XÃ¡c nháº­n',okText='Äá»“ng Ã½',cancelText='Há»§y'}={})=>openDialog({title,message:msg,okText,cancelText});

/* ===== Highlight helpers cho trÆ°á»ng báº¯t buá»™c ===== */
function setInvalid(el, msg){
  if(!el) return false;
  el.classList.add('input-invalid');
  el.setAttribute('aria-invalid','true');
  if(msg) el.setAttribute('title', msg);
  try{ el.focus(); el.select?.(); }catch(_){}
  return false;
}
function clearInvalid(el){
  if(!el) return;
  el.classList.remove('input-invalid');
  el.removeAttribute('aria-invalid');
  el.removeAttribute('title');
}
function validateNotEmpty(el, msg='TrÆ°á»ng nÃ y lÃ  báº¯t buá»™c'){
  const v = String(el?.value||'').trim();
  if(!v) return setInvalid(el, msg);
  clearInvalid(el); return true;
}

/* ===== Bottom Sheet ===== */
let sheetMode=null, sheetPayload=null;
function openSheet(mode,payload){
  sheetMode=mode; sheetPayload=payload||null;
  const sh=$('sheet'), title=$('sheetTitle'), body=$('sheetBody'), act=$('sheetConfirm');
  body.innerHTML=''; act.onclick=null; act.className='btn-primary'; act.textContent='LÆ°u'; act.style.display='inline-block';

  if(mode==='appTools'){
    title.textContent='Tiá»‡n Ã­ch'; act.style.display='none';
    body.innerHTML=`
      <div class="tool-list" id="toolList">
        <!-- âš™ï¸ NÃºt cÃ i Ä‘áº·t sáº½ chÃ¨n Ä‘á»™ng náº¿u Ä‘á»§ Ä‘iá»u kiá»‡n -->
        <div class="tool-item" id="toolExport"><div class="tool-ico">ğŸ’¾</div><div class="tool-main"><div class="tool-title">Sao lÆ°u dá»¯ liá»‡u</div><div class="tool-sub">Xuáº¥t file JSON (rice-scale-data.json)</div></div></div>
        <div class="tool-item" id="toolImport"><div class="tool-ico">ğŸ”„</div><div class="tool-main"><div class="tool-title">KhÃ´i phá»¥c dá»¯ liá»‡u</div><div class="tool-sub">Chá»n file JSON Ä‘Ã£ sao lÆ°u Ä‘á»ƒ nháº­p</div></div></div>
        <div class="tool-item" id="toolWipe"><div class="tool-ico">ğŸ—‘</div><div class="tool-main"><div class="tool-title">XÃ³a bá»™ nhá»›</div><div class="tool-sub">XÃ³a sáº¡ch dá»¯ liá»‡u TÃ­nh cÃ¢n lÃºa Ä‘ang lÆ°u trÃªn mÃ¡y</div></div></div>
        <div class="tool-item" id="toolHelp"><div class="tool-ico">ğŸ¬</div><div class="tool-main"><div class="tool-title">HÆ°á»›ng dáº«n sá»­ dá»¥ng</div><div class="tool-sub">Má»Ÿ video hÆ°á»›ng dáº«n trÃªn YouTube</div></div></div>
        <div class="tool-item" id="toolInfo"><div class="tool-ico">â„¹ï¸</div><div class="tool-main"><div class="tool-title">ThÃ´ng tin á»©ng dá»¥ng</div><div class="tool-sub">PhiÃªn báº£n, mÃ´ táº£, dung lÆ°á»£ng dá»¯ liá»‡u</div></div></div>
      </div>`;

    // âœ… chÃ¨n nÃºt CÃ i Ä‘áº·t náº¿u Ä‘á»§ Ä‘iá»u kiá»‡n
    if (window.__a2hs?.eligible()){
      const li = document.createElement('div');
      li.className = 'tool-item';
      li.id = 'toolInstall';
      li.innerHTML = `<div class="tool-ico">ğŸ“¥</div>
        <div class="tool-main">
          <div class="tool-title">CÃ i Ä‘áº·t á»©ng dá»¥ng</div>
          <div class="tool-sub">CÃ i Ä‘áº·t á»©ng dá»¥ng Ä‘á»ƒ dÃ¹ng nhanh hÆ¡n, lÆ°u trá»¯ dá»¯ liá»‡u an toÃ n vÃ  khÃ´ng cáº§n máº¡ng internet.</div>
        </div>`;
      const list = document.getElementById('toolList');
      list.insertBefore(li, list.firstChild);
      li.addEventListener('click', async ()=>{
        closeSheet();
        await window.__a2hs.triggerInstall();
      });
    }

    $('toolExport').addEventListener('click',()=>{ closeSheet(); exportData(); });
    $('toolImport').addEventListener('click',()=>{ openRestorePicker(); });
    $('toolWipe').addEventListener('click', async ()=>{
      const ok = await showConfirm(
        'XÃ³a toÃ n bá»™ dá»¯ liá»‡u TÃ­nh cÃ¢n lÃºa? HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c.',
        { title:'XÃ³a dá»¯ liá»‡u', okText:'XÃ³a', cancelText:'Há»§y' }
      );
      if (!ok) return;

      // 1) XoÃ¡ storage
      try { localStorage.removeItem(STORAGE_KEY); } catch(e) {}

      // 2) Reset state ná»™i bá»™
      state = { groups:{}, activeGroup:'', activeFarmer:'', view:'groups' };

      // 3) ÄÃ³ng sheet (náº¿u Ä‘ang má»Ÿ)
      closeSheet();

      // 4) Ã‰p Ä‘iá»u hÆ°á»›ng vá» #groups vÃ  cáº­p nháº­t UI (KHÃ”NG reload)
      try { history.replaceState({ view:'groups' }, '', '#groups'); } catch(_) {}
      render();

      // 5) LÆ°u tráº¡ng thÃ¡i rá»—ng
      save();

      // 6) ThÃ´ng bÃ¡o
      await showAlert('ÄÃ£ xÃ³a toÃ n bá»™ dá»¯ liá»‡u.');
    });
    $('toolHelp').addEventListener('click',()=>{ window.open('https://www.youtube.com/','_blank','noopener,noreferrer'); });
    $('toolInfo').addEventListener('click',()=> openSheet('appInfo'));
  }

  if(mode==='appInfo'){
    title.textContent='ThÃ´ng tin á»©ng dá»¥ng'; act.style.display='none';
    const raw = JSON.stringify(state||{}, null, 0); const size = formatBytes(byteLen(raw));
    body.innerHTML=`
      <div class="field"><div style="font-size:14px;line-height:1.6;border:1px dashed var(--border);border-radius:12px;padding:10px">TÃNH CÃ‚N LÃšA lÃ  á»©ng dá»¥ng giÃºp nháº­p nhanh khá»‘i lÆ°á»£ng tá»«ng bao lÃºa theo báº£ng tÃ­nh 5Ã—5, tá»± Ä‘á»™ng tÃ­nh toÃ¡n khá»‘i lÆ°á»£ng, trá»« bÃ¬, thÃ nh tiá»n cho tá»«ng chá»§ lÃºa vÃ  tá»«ng ghe, xe. <p>á»¨ng dá»¥ng cÃ³ thá»ƒ cÃ i Ä‘áº·t trÃªn Android/iOS Ä‘á»ƒ dÃ¹ng offline vÃ  há»— trá»£ sao lÆ°u/khÃ´i phá»¥c dá»¯ liá»‡u.</p></div></div>
      <div class="field"><label>PhiÃªn báº£n hiá»‡n táº¡i</label><input type="text" readonly value="${APP_VERSION}"></div>
      <div class="field"><label>TÃ¡c giáº£</label><input type="text" readonly value="HoÃ ng Äá»£i"></div>
      <div class="field"><label>Dung lÆ°á»£ng dá»¯ liá»‡u hiá»‡n táº¡i</label><input type="text" readonly value="${size}"></div>`;
  }

  if(mode==='addGroup'){
    title.textContent='ThÃªm ghe, xe'; act.textContent='ThÃªm';
    body.innerHTML=`
      <div class="field required"><label for="inName">TÃªn ghe, xe</label>
        <input id="inName" type="text" placeholder="VD: Ghe TÆ° Háº£i / Xe 83A-12345" required autofocus><div class="tip-text">(*) Nháº­p tÃªn ghe hoáº·c xe</div></div>
      <div class="field"><label for="inPhone">Sá»‘ Ä‘iá»‡n thoáº¡i</label>
        <input id="inPhone" type="tel" inputmode="numeric" placeholder="VD: 0123456789"><div class="tip-text">(*) Sá»‘ Ä‘iá»‡n thoáº¡i cá»§a ghe, xe ( khÃ´ng báº¯t buá»™c )</div></div>`;
    const inName = $('inName');
    inName.addEventListener('input', ()=> clearInvalid(inName));
    $('sheetConfirm').onclick=()=>{
      if(!validateNotEmpty(inName,'Vui lÃ²ng nháº­p tÃªn ghe, xe')) return;
      const name=inName.value.trim();
      if(state.groups[name]){ setInvalid(inName,'TÃªn ghe, xe Ä‘Ã£ tá»“n táº¡i'); showAlert('TÃªn ghe, xe Ä‘Ã£ tá»“n táº¡i.'); return; }
      const phone=$('inPhone').value.trim();
      state.groups[name]={ownerPhone:phone||'', farmers:{}, createdAt:Date.now()};
      state.activeGroup=name; state.activeFarmer=''; closeSheet(); navTo('farmers');
    };
  }

  if(mode==='editGroup'){
    const g=payload; const grp=state.groups[g];
    title.textContent='Sá»­a thÃ´ng tin ghe, xe'; act.textContent='Cáº­p nháº­t';
    body.innerHTML=`
      <div class="field required"><label for="inName">TÃªn ghe, xe</label>
        <input id="inName" type="text" placeholder="VD: Ghe TÆ° Háº£i / Xe 83A-12345" value="${escapeHtml(g)}" required autofocus><div class="tip-text">(*) Nháº­p tÃªn ghe hoáº·c xe</div></div>
      <div class="field"><label for="inPhone">Sá»‘ Ä‘iá»‡n thoáº¡i</label>
        <input id="inPhone" type="tel" inputmode="numeric" placeholder="VD: 0123456789" value="${escapeHtml(grp?.ownerPhone||'')}"><div class="tip-text">(*) Sá»‘ Ä‘iá»‡n thoáº¡i cá»§a ghe, xe ( khÃ´ng báº¯t buá»™c )</div></div>`;
    const inName = $('inName');
    inName.addEventListener('input', ()=> clearInvalid(inName));
    $('sheetConfirm').onclick=()=>{
      const newName=inName.value.trim();
      if(!validateNotEmpty(inName,'Vui lÃ²ng nháº­p tÃªn ghe, xe')) return;
      if(newName!==g && state.groups[newName]){ setInvalid(inName,'TÃªn ghe, xe Ä‘Ã£ tá»“n táº¡i'); showAlert('TÃªn ghe, xe Ä‘Ã£ tá»“n táº¡i.'); return; }
      const phone=$('inPhone').value.trim(); const data=state.groups[g];
      delete state.groups[g]; state.groups[newName]={...data, ownerPhone:phone};
      if(state.activeGroup===g) state.activeGroup=newName; closeSheet(); save();
    };
  }

  if(mode==='addFarmer'){
    if(!state.activeGroup){showAlert('Chá»n ghe, xe trÆ°á»›c.');return}
    title.textContent='ThÃªm chá»§ lÃºa'; act.textContent='ThÃªm';
    body.innerHTML=`
      <div class="field required"><label for="inName">TÃªn chá»§ lÃºa</label>
        <input id="inName" type="text" placeholder="VD: ChÃº NÄƒm / Anh Háº­u" required autofocus><div class="tip-text">(*) Nháº­p vÃ o tÃªn chá»§ lÃºa</div></div>
      <div class="field"><label for="inFPrice">ÄÆ¡n giÃ¡ (Ä‘/kg)</label>
        <input id="inFPrice" type="number" inputmode="decimal" placeholder="VD: 7100"><div class="tip-text">(*) Nháº­p Ä‘Æ¡n giÃ¡ lÃºa tÃ­nh theo kg ( khÃ´ng báº¯t buá»™c )</div></div>
      <div class="field"><label for="inTare">Quy táº¯c bÃ¬</label>
        <input id="inTare" type="number" inputmode="numeric" min="0" step="1" placeholder="VD: 10"><div class="tip-text">(*) Má»—i X bao = 1kg ( khÃ´ng báº¯t buá»™c )</div></div>
      <div class="mode-section">
        <div class="mode-title">Quy cÃ¡ch nháº­p &lt; 100kg</div>
        <label class="mode-option"><input type="radio" name="inMode" value="lt2"> 2 sá»‘ â€” 50 â†’ 50kg</label>
        <label class="mode-option"><input type="radio" name="inMode" value="lt3" checked> 3 sá»‘ â€” 552 â†’ 55,2kg (gram cháºµn)</label>
      </div>
      <div class="mode-section">
        <div class="mode-title">Quy cÃ¡ch nháº­p â‰¥ 100kg</div>
        <label class="mode-option"><input type="radio" name="inMode" value="ge3"> 3 sá»‘ â€” 100 â†’ 100kg</label>
        <label class="mode-option"><input type="radio" name="inMode" value="ge4"> 4 sá»‘ â€” 100,4kg (cháºµn)</label>
      </div>`;
    const inName = $('inName');
    inName.addEventListener('input', ()=> clearInvalid(inName));
    $('sheetConfirm').onclick=()=>{
      if(!validateNotEmpty(inName,'Vui lÃ²ng nháº­p tÃªn chá»§ lÃºa')) return;
      const v=inName.value.trim(); const grp=getActiveGroup();
      if(grp.farmers[v]){ setInvalid(inName,'TÃªn chá»§ lÃºa Ä‘Ã£ tá»“n táº¡i'); showAlert('TÃªn chá»§ lÃºa Ä‘Ã£ tá»“n táº¡i.'); return; }
      const fp=Number($('inFPrice').value)||0;
      const tr=Math.max(0, Math.floor(Number($('inTare').value)||0));
      const im=document.querySelector('input[name="inMode"]:checked')?.value || 'lt3';
      grp.farmers[v]={price:fp, inputMode:im, tareRule:tr, tables:[newEmptyTable()], createdAt:Date.now()};
      state.activeFarmer=v; closeSheet(); navTo('tables');
    };
  }

  if(mode==='renameFarmer'){
    const f=payload; title.textContent='Äá»•i tÃªn chá»§ lÃºa'; act.textContent='LÆ°u';
    body.innerHTML=`<div class="field required"><label for="inName">TÃªn chá»§ lÃºa</label>
      <input id="inName" type="text" value="${escapeHtml(f)}" required autofocus></div>`;
    const inName = $('inName');
    inName.addEventListener('input', ()=> clearInvalid(inName));
    $('sheetConfirm').onclick=()=>{
      const grp=getActiveGroup(); const v=inName.value.trim();
      if(!validateNotEmpty(inName,'Vui lÃ²ng nháº­p tÃªn chá»§ lÃºa')) return;
      if(v===f){ closeSheet(); return; }
      if(grp.farmers[v]){ setInvalid(inName,'TÃªn chá»§ lÃºa Ä‘Ã£ tá»“n táº¡i'); showAlert('TÃªn chá»§ lÃºa Ä‘Ã£ tá»“n táº¡i.'); return; }
      grp.farmers[v]=grp.farmers[f]; delete grp.farmers[f]; if(state.activeFarmer===f) state.activeFarmer=v; closeSheet(); save();
    };
  }

  if(mode==='setFarmerPrice'){
    const farmer=getActiveFarmer(); if(!farmer){showAlert('ChÆ°a chá»n chá»§ lÃºa.'); return;}
    title.textContent='ÄÆ¡n giÃ¡ (Ä‘/kg)'; act.textContent='LÆ°u';
    body.innerHTML=`<div class="field"><label for="inFPrice">ÄÆ¡n giÃ¡ (Ä‘/kg)</label>
      <input id="inFPrice" type="number" inputmode="decimal" value="${farmer.price||''}" placeholder="VD: 7100"></div>`;
    $('sheetConfirm').onclick=()=>{const v=Number($('inFPrice').value)||0; farmer.price=v; closeSheet(); save();};
  }

  $('sheetBackdrop').classList.add('open'); sh.classList.add('open');
}
function closeSheet(){
  $('sheetBackdrop').classList.remove('open');
  $('sheet').classList.remove('open');
  const act=$('sheetConfirm');
  if (act){ act.style.display='inline-block'; act.className='btn-primary'; act.textContent='LÆ°u'; act.onclick=null; }
}

/* ===== File I/O ===== */
function openRestorePicker(){ const inp=$('fileInput'); inp.value=''; inp.click(); }
function exportData(){ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rice-scale-data.json'; a.click(); URL.revokeObjectURL(a.href); }

/* --- Sanitizer dá»¯ liá»‡u import --- */
function sanitizeState(obj){
  const out = {groups:{}, activeGroup:'', activeFarmer:'', view:'groups'};
  if (!obj || typeof obj!=='object') return out;
  if (obj.groups && typeof obj.groups==='object'){
    for (const g of Object.keys(obj.groups)){
      const grp = obj.groups[g];
      if (!grp || typeof grp!=='object') continue;
      const safeGrp = {
        ownerPhone: String(grp.ownerPhone||''),
        farmers: {},
        createdAt: Number(grp.createdAt||Date.now())
      };
      if (grp.farmers && typeof grp.farmers==='object'){
        for (const f of Object.keys(grp.farmers)){
          const fm = grp.farmers[f];
          if (!fm || typeof fm!=='object') continue;
          const tables = Array.isArray(fm.tables) ? fm.tables.map(t=>{
            if (!Array.isArray(t)) return Array.from({length:25},()=>null);
            const a = t.slice(0,25).map(x=> (typeof x==='number' && isFinite(x)) ? x : null);
            while (a.length<25) a.push(null);
            return a;
          }) : [Array.from({length:25},()=>null)];
          safeGrp.farmers[f] = {
            price: Number(fm.price||0),
            inputMode: ['lt2','lt3','ge3','ge4'].includes(fm.inputMode) ? fm.inputMode : 'lt3',
            tareRule: Math.max(0, Math.floor(Number(fm.tareRule||0))),
            tables,
            createdAt: Number(fm.createdAt||Date.now())
          };
        }
      }
      out.groups[g] = safeGrp;
    }
  }
  return out;
}

$('fileInput').addEventListener('change',e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{ try{
      const obj=sanitizeState(JSON.parse(reader.result));
      if(!obj || !obj.groups) throw new Error('Sai Ä‘á»‹nh dáº¡ng');
      state=obj; migrateCreatedAt(); save(); showAlert('KhÃ´i phá»¥c dá»¯ liá»‡u thÃ nh cÃ´ng.','ThÃ nh cÃ´ng');
    }catch(err){ showAlert('Lá»—i khÃ´i phá»¥c: '+escapeHtml(err.message),'Lá»—i'); } };
  reader.readAsText(file);
});

/* ===== Delete actions ===== */
async function onDeleteGroup(name){
  const ok = await showConfirm(`XoÃ¡ ghe, xe "<b>${escapeHtml(name)}</b>" vÃ  toÃ n bá»™ dá»¯ liá»‡u liÃªn quan?`, {title:'XÃ³a ghe, xe', okText:'XÃ³a', cancelText:'Há»§y'});
  if(!ok) return;
  if(!state.groups[name]) return;
  delete state.groups[name];
  if(state.activeGroup===name){ state.activeGroup=''; state.activeFarmer=''; navTo('groups'); } else { save(); }
}
async function onDeleteFarmer(name){
  const ok = await showConfirm(`XoÃ¡ chá»§ lÃºa "<b>${escapeHtml(name)}</b>" vÃ  dá»¯ liá»‡u liÃªn quan?`, {title:'XÃ³a chá»§ lÃºa', okText:'XÃ³a', cancelText:'Há»§y'});
  if(!ok) return;
  const grp=getActiveGroup(); if(!grp || !grp.farmers) return;
  delete grp.farmers[name];
  if(state.activeFarmer===name){ state.activeFarmer=''; navTo('farmers'); } else { save(); }
}

/* ===== Navigation ===== */
// Chuáº©n hoÃ¡ view theo tÃ¬nh tráº¡ng dá»¯ liá»‡u hiá»‡n cÃ³
function normalizeViewByState(desired){
  const hasAnyGroup = Object.keys(state.groups||{}).length > 0;
  if (!hasAnyGroup) return 'groups';
  if (desired === 'farmers' && !state.activeGroup) return 'groups';
  if (desired === 'tables'){
    if (!state.activeGroup) return 'groups';
    if (!state.activeFarmer) return 'farmers';
  }
  return desired;
}

function navTo(v){
  const safeV = normalizeViewByState(v);
  if (state.view !== safeV){
    state.view = safeV;
    if ((history.state?.view || '') !== safeV){
      history.pushState({view:safeV}, '', '#'+safeV);
    }
    save();
  } else {
    render();
  }
}

// âœ… Back Ä‘á»“ng bá»™ vá»›i há»‡ thá»‘ng
function navBack(){
  if (history.length > 1){
    history.back();
    return;
  }
  if (state.view !== 'groups'){
    state.view = 'groups';
    history.replaceState({view:'groups'}, '', '#groups');
    save();
  }
}

// Äá»“ng bá»™ khi popstate (cháº·n view khÃ´ng há»£p lá»‡)
window.addEventListener('popstate', (e)=>{
  let view = e.state?.view || (location.hash ? location.hash.slice(1) : 'groups');
  view = ['groups','farmers','tables'].includes(view) ? view : 'groups';
  const normalized = normalizeViewByState(view);
  if (normalized !== view){
    history.replaceState({view: normalized}, '', '#'+normalized);
  }
  state.view = normalized;
  render();
});

/* ===== Render ===== */
function render(){
  $('btnBack').style.display=(state.view==='groups')?'none':'inline-block';
  $('appSub').textContent= state.view==='groups'?'Danh sÃ¡ch ghe, xe': state.view==='farmers'?'Danh sÃ¡ch chá»§ lÃºa':'Báº£ng nháº­p liá»‡u cÃ¢n lÃºa';
  $('appTitle').textContent='TÃNH CÃ‚N LÃšA';

  const fabAddGroup = $('fabAddGroup'), fabAddFarmer = $('fabAddFarmer');
  fabAddGroup.style.display = (state.view==='groups')?'grid':'none';
  fabAddFarmer.style.display = (state.view==='farmers')?'grid':'none';

  if(state.view==='groups'){ renderGroupsView(); $('view-groups').style.display='block'; $('view-farmers').style.display='none'; $('view-tables').style.display='none'; }
  if(state.view==='farmers'){ renderFarmersView(); $('view-groups').style.display='none'; $('view-farmers').style.display='block'; $('view-tables').style.display='none'; }
  if(state.view==='tables'){ renderTables(); $('view-groups').style.display='none'; $('view-farmers').style.display='none'; $('view-tables').style.display='block'; }
}

/* ===== TÃ­nh tá»•ng cho ghe, xe ===== */
function calcGroupDisplay(grp){
  let totalKg = 0;
  let totalBags = 0;
  for (const f of Object.keys(grp.farmers || {})){
    const farmer = grp.farmers[f];
    const kg = farmer.tables.reduce((s,t)=> s + sumTable(t), 0);
    const bags = farmer.tables.reduce((n,t)=> n + t.filter(x => typeof x==='number').length, 0);
    totalKg += kg;
    totalBags += bags;
  }
  return { totalKg, totalBags };
}

/* View 1: Groups */
function renderGroupsView(){
  const host=$('groupList'); host.innerHTML='';
  const names=Object.keys(state.groups||{});
  $('chipGroups').textContent='Ghe, xe: ' + fmt(names.length);

  if(!names.length){
    host.innerHTML = `
      <div class="group-card">
        <div class="g-body">
          <div class="fake-input" style="padding:12px">
            Báº¥m nÃºt <b>â• THÃŠM</b> Ä‘á»ƒ thÃªm tÃªn <b>ghe, xe</b><br><br>
            <ul style="margin:0 0 0 18px; padding:0; line-height:1.5">
              <li><strong>Ghe, xe:</strong> chá»©a má»™t hoáº·c nhiá»u chá»§ lÃºa.</li>
              <li><strong>TÃªn ghe, xe:</strong> cÃ³ thá»ƒ lÃ  tÃªn chá»§ ghe, nhÃ  xe, tÃ i xáº¿, biá»ƒn sá»‘ xe, ...</li>
            </ul>
          </div>
        </div>
      </div>`;
    return;
  }
  // má»›i nháº¥t lÃªn trÆ°á»›c
  names.sort((a,b)=> (state.groups[b]?.createdAt||0) - (state.groups[a]?.createdAt||0));

  for(const g of names){
    const grp=state.groups[g]; const stat=calcGroupDisplay(grp);
    const card=document.createElement('div'); card.className='group-card'; card.dataset.group=g;
    const titleDate = formatDateTimeDDMM_HHmm(grp.createdAt);
    card.innerHTML = `<div class="g-head"><div class="g-title">ğŸ—“ï¸ ${titleDate}</div><div class="chip">${fmt(stat.totalBags)} bao</div></div>`;
    const body=document.createElement('div'); body.className='g-body';
    const info=document.createElement('div'); info.className='fake-input';
    info.appendChild(buildKV('TÃªn ghe, xe:', g));
    info.appendChild(buildKV('Sá»‘ bao (láº§n cÃ¢n):', fmt(stat.totalBags) + ' bao', 'accent'));
    info.appendChild(buildKV('Tá»•ng cÃ¢n:', fmt(stat.totalKg) + ' kg', 'danger'));
    info.appendChild(buildKV('SÄT:', (grp.ownerPhone||'â€”')));
    body.appendChild(info);
    const foot=document.createElement('div'); foot.className='g-foot';
    const btnEdit=document.createElement('button'); btnEdit.className='btn-ghost'; btnEdit.textContent='âœ Sá»­a';
    const btnDel=document.createElement('button'); btnDel.className='btn-danger'; btnDel.textContent='ğŸ—‘ XoÃ¡';
    btnEdit.addEventListener('click',e=>{ e.stopPropagation(); openSheet('editGroup',g); });
    btnDel.addEventListener('click',e=>{ e.stopPropagation(); onDeleteGroup(g); });
    foot.appendChild(btnEdit); foot.appendChild(btnDel);
    card.appendChild(body); card.appendChild(foot);
    card.addEventListener('click',()=>{ state.activeGroup=g; state.activeFarmer=''; navTo('farmers'); });
    host.appendChild(card);
  }
}

/* View 2: Farmers */
function renderFarmersView(){
  const host=$('farmerList'); host.innerHTML='';
  const grp=getActiveGroup(); if(!grp){ host.innerHTML='<div class=meta>ChÆ°a cÃ³ ghe, xe.</div>'; return; }
  $('chipGroupName').textContent=state.activeGroup||'â€”';

  const names=Object.keys(grp.farmers||{});
  $('chipFarmerCount').textContent = 'Chá»§ lÃºa: ' + fmt(names.length);

  if(!names.length){
    const gname = state.activeGroup || 'â€”';
    host.innerHTML = `
      <div class="group-card">
        <div class="g-body">
          <div class="fake-input" style="padding:12px">
            Báº¥m nÃºt <b>ğŸ‘¤ THÃŠM</b> Ä‘á»ƒ thÃªm <b>chá»§ lÃºa & báº£ng tÃ­nh</b> vÃ o ghe, xe <b>${escapeHtml(gname)}</b><br><br>
            <ul style="margin:0 0 0 18px; padding:0; line-height:1.5">
              <li><strong>TÃªn chá»§ lÃºa:</strong> vÃ­ dá»¥ ChÃº NÄƒm, Anh Háº­uâ€¦</li>
              <li><strong>ÄÆ¡n giÃ¡ (Ä‘/kg):</strong> cÃ³ thá»ƒ Ä‘á»ƒ trá»‘ng, thiáº¿t láº­p sau.</li>
              <li><strong>Quy táº¯c bÃ¬:</strong> má»—i X bao trá»« 1kg (Ä‘áº·t 0 náº¿u khÃ´ng trá»«).</li>
              <li><strong>Quy cÃ¡ch nháº­p:</strong> chá»n 2 sá»‘ / 3 sá»‘ (cháºµn) cho &lt;100kg, hoáº·c 3/4 sá»‘ cho â‰¥100kg.</li>
            </ul>
          </div>
        </div>
      </div>`;
    // Reset thá»‘ng kÃª Ä‘áº§u trang vá» 0
    $('stat2Bags').value='0 bao';
    $('stat2Kg').value='0 kg';
    return;
  }

  let totalBags=0, totalKg=0;
  names.sort((a,b)=> (grp.farmers[b]?.createdAt||0) - (grp.farmers[a]?.createdAt||0));

  for(const f of names){
    const farmer=grp.farmers[f];
    const bags=farmer.tables.reduce((n,t)=> n+t.filter(x=> typeof x==='number').length,0);
    const kg=farmer.tables.reduce((s,t)=> s+sumTable(t),0);

    totalBags+=bags;
    totalKg+=kg;

    const unit=(farmer.price||0);
    const tareRule=Math.max(0, farmer.tareRule||0);
    const tareKg = tareRule>0 ? Math.floor(bags / tareRule) : 0;
    const remaining = Math.max(0, kg - tareKg);
    const money=Math.round(unit*remaining);

    const card=document.createElement('div'); card.className='group-card'; card.dataset.farmer=f;
    const titleDate = formatDateTimeDDMM_HHmm(farmer.createdAt);
    card.innerHTML = `<div class="g-head"><div class="g-title">ğŸ—“ï¸ ${titleDate}</div><div class="chip">${fmt(bags)} bao</div></div>`;

    const body=document.createElement('div'); body.className='g-body';
    const info=document.createElement('div'); info.className='fake-input';
    info.appendChild(buildKV('TÃªn chá»§ lÃºa:', f));
    info.appendChild(buildKV('Sá»‘ bao (láº§n cÃ¢n):', fmt(bags) + ' bao', 'accent'));
    info.appendChild(buildKV('Tá»•ng cÃ¢n:', fmt(kg)+' kg', 'orange'));
    info.appendChild(buildKV('Trá»« bÃ¬:', fmt(tareKg)+' kg', 'accent'));
    info.appendChild(buildKV('CÃ²n láº¡i (Ä‘Ã£ trá»« bÃ¬):', fmt(remaining)+' kg', 'orange'));
    info.appendChild(buildKV('ÄÆ¡n giÃ¡ (Ä‘/kg):', fmt(unit)+' Ä‘', 'accent'));
    info.appendChild(buildKV('ThÃ nh tiá»n:', vnd(money), 'danger'));
    info.appendChild(buildKV('Quy cÃ¡ch nháº­p:', labelInputMode(farmer.inputMode)));
    body.appendChild(info);

    const foot=document.createElement('div'); foot.className='g-foot';
    const btnPrice=document.createElement('button'); btnPrice.className='btn-ghost'; btnPrice.textContent='â‚« ÄÆ¡n giÃ¡';
    const btnRename=document.createElement('button'); btnRename.className='btn-ghost'; btnRename.textContent='âœ Äá»•i tÃªn';
    const btnDel=document.createElement('button'); btnDel.className='btn-danger'; btnDel.textContent='ğŸ—‘ XoÃ¡';

    btnPrice.addEventListener('click',e=>{ e.stopPropagation(); state.activeFarmer = f; openSheet('setFarmerPrice'); });
    btnRename.addEventListener('click',e=>{ e.stopPropagation(); openSheet('renameFarmer', f); });
    btnDel.addEventListener('click',e=>{ e.stopPropagation(); onDeleteFarmer(f); });

    foot.appendChild(btnPrice); foot.appendChild(btnRename); foot.appendChild(btnDel);
    card.appendChild(body); card.appendChild(foot);

    // Click má»Ÿ báº£ng 5Ã—5 cá»§a chá»§ lÃºa
    card.addEventListener('click',()=>{ state.activeFarmer=f; navTo('tables'); });
    host.appendChild(card);
  }

  $('stat2Bags').value = fmt(totalBags) + ' bao';
  $('stat2Kg').value  = fmt(totalKg) + ' kg';
}

/* View 3: Tables */
function renderTables(){
  const host=$('tables'); host.innerHTML='';
  const title=$('contextTitle');
  if(!state.activeGroup){ title.textContent='Báº¢NG 5Ã—5'; host.innerHTML='<div class=meta>Chá»n ghe, xe trÆ°á»›c.</div>'; return; }
  if(!state.activeFarmer){ title.textContent='Báº¢NG 5Ã—5'; host.innerHTML='<div class=meta>Chá»n chá»§ lÃºa.</div>'; return; }

  const farmer=getActiveFarmer(); if(!farmer) return;
  if(!farmer.tables||farmer.tables.length===0) farmer.tables=[newEmptyTable()];

  const totalKg=farmer.tables.reduce((acc,t)=>acc+sumTable(t),0);
  const totalBags=farmer.tables.reduce((n,t)=> n+t.filter(x=>typeof x==='number').length,0);
  const tareRule = Math.max(0, farmer.tareRule||0);
  const tareKg = tareRule>0 ? Math.floor(totalBags / tareRule) : 0;
  const remainingKg=Math.max(0,totalKg - tareKg);
  const price=Number(farmer.price||0);
  const amount=Math.round(remainingKg*price);

  title.textContent=`TÃªn chá»§ lÃºa: ${state.activeFarmer}`;

  const stats=document.createElement('div'); stats.className='stat-grid'; stats.innerHTML=`
    <div class=stat style="grid-column:1/ -1"><label><b>TÃªn chá»§ lÃºa</b></label><input id=statFarmerName type=text class="view3-orange" value="${escapeHtml(state.activeFarmer)}"/><div class="tip-text">(*) CÃ³ thá»ƒ Ä‘á»•i tÃªn chá»§ lÃºa táº¡i Ä‘Ã¢y</div></div>
    <div class=stat style="grid-column:1/ -1"><label><b>Sá»‘ bao (láº§n cÃ¢n)</b></label><input id=statBags type=text class="view3-accent" value="${fmt(totalBags)} bao" readonly><div class="tip-text">(*) Tá»•ng sá»‘ bao hoáº·c sá»‘ láº§n cÃ¢n</div></div>
    <div class=stat style="grid-column:1/ -1"><label><b>Tá»•ng cÃ¢n (kg)</b></label><input id=statTotalKg class="view3-danger" type=text value="${fmt(totalKg)} kg" readonly><div class="tip-text">(*) Khá»‘i lÆ°á»£ng tá»•ng chÆ°a trá»« bÃ¬</div></div>
    <div class=stat style="grid-column:1/ -1"><label><b>Quy táº¯c bÃ¬ (X bao = 1 kg)</b></label><input id=statTareRule class="view3-orange" type=number min=0 step=1 value="${tareRule}"><div class="tip-text">(*) Má»—i X bao sáº½ tá»± Ä‘á»™ng trá»« 1&nbsp;kg khá»i tá»•ng cÃ¢n</div></div>
    <div class=stat style="grid-column:1/ -1"><label><b>Trá»« bÃ¬ (kg)</b></label><input id=statTareKg type=text class="view3-accent" value="${fmt(tareKg)} kg" readonly><div class="tip-text">(*) Khá»‘i lÆ°á»£ng bá»‹ trá»« theo quy táº¯c bÃ¬</div></div>
    <div class=stat style="grid-column:1/ -1"><label><b>CÃ²n láº¡i (kg)</b></label><input id=statRemain class="view3-danger" type=text value="${fmt(remainingKg)} kg" readonly><div class="tip-text">(*) Khá»‘i lÆ°á»£ng thá»±c tÃ­nh tiá»n sau khi Ä‘Ã£ trá»« bÃ¬</div></div>
    <div class=stat style="grid-column:1/ -1"><label><b>ÄÆ¡n giÃ¡ (Ä‘/kg)</b></label><input id=statPrice class="view3-orange" type=number inputmode=decimal value="${price||0}"><div class="tip-text">(*) Nháº­p Ä‘Æ¡n giÃ¡ lÃºa tÃ­nh theo kg</div></div>
    <div class=stat style="grid-column:1/ -1"><label><b>ThÃ nh tiá»n (Ä‘)</b></label><input id=statAmount class="view3-danger" type=text value="${vnd(amount)}" readonly><div class="tip-text">(*) = CÃ²n láº¡i (kg) Ã— ÄÆ¡n giÃ¡ (Ä‘/kg)</div></div>`;
  host.appendChild(stats);

  const statNameEl = $('statFarmerName');
  statNameEl.addEventListener('input', ()=> clearInvalid(statNameEl));
  $('statFarmerName').addEventListener('change',()=>{
    const newName=statNameEl.value.trim(); const oldName=state.activeFarmer;
    if(!newName){ setInvalid(statNameEl,'Vui lÃ²ng nháº­p tÃªn chá»§ lÃºa'); statNameEl.value=oldName; return; }
    if(newName===oldName) return;
    const grp=getActiveGroup();
    if(grp.farmers[newName]){ setInvalid(statNameEl,'TÃªn chá»§ lÃºa Ä‘Ã£ tá»“n táº¡i'); showAlert('TÃªn chá»§ lÃºa Ä‘Ã£ tá»“n táº¡i.'); statNameEl.value=oldName; return; }
    grp.farmers[newName]=grp.farmers[oldName]; delete grp.farmers[oldName]; state.activeFarmer=newName; save();
  });
  $('statTareRule').addEventListener('change',()=>{
    const v=Math.max(0, Math.floor(Number($('statTareRule').value)||0));
    const f=getActiveFarmer(); if(!f) return; f.tareRule=v; save();
  });
  $('statTareRule').title = tareRule === 0 ? '0 = khÃ´ng trá»« bÃ¬ theo sá»‘ bao' : 'Má»—i X bao trá»« 1 kg';
  $('statPrice').addEventListener('change',()=>{ const f=getActiveFarmer(); if(!f) return; f.price=Number($('statPrice').value)||0; save(); });

  farmer.tables.forEach((tbl,ti)=>{
    const card=document.createElement('div'); card.className='table-card';
    card.innerHTML=`<div class="table-head"><div class="section-title title">Báº¢NG ${ti+1}</div></div>
                    <div class="colheads"><span>C1</span><span>C2</span><span>C3</span><span>C4</span><span>C5</span></div>`;
    const cells=document.createElement('div'); cells.className='cells';
    for(let row=0; row<5; row++){
      for(let col=0; col<5; col++){
        const ci=row*5+col; const inp=document.createElement('input'); inp.type='text'; inp.inputMode='numeric'; inp.dataset.key=`${ti}-${ci}`;
        const v=tbl[ci];
        if (typeof v==='number'&&!isNaN(v)){
          const hasDecimal = (farmer.inputMode==='lt3' || farmer.inputMode==='ge4');
          const asText = hasDecimal ? v.toFixed(1) : String(v); inp.value = asText;
          const isWarn = hasDecimal && String(asText).includes('.') && (Math.round((v*10)%10)%2===1); if(isWarn) inp.classList.add('warn');
        } else { inp.value=''; }
        const enabled=isCellEnabled(farmer,ti,ci); if(!enabled) inp.setAttribute('disabled','disabled');
        inp.addEventListener('input', e=> commitCellInput(farmer,ti,ci,e.target.value,e,inp));
        inp.addEventListener('keydown', ev=>{ if(ev.key==='Enter'){ commitCellInput(farmer,ti,ci,inp.value,ev,inp); } });
        cells.appendChild(inp);
      }
    }
    const colTotals=document.createElement('div'); colTotals.className='colTotals';
    for(let c=0;c<5;c++){ const sp=document.createElement('span'); sp.textContent = fmt(sumCol(tbl,c)); colTotals.appendChild(sp); }
    const s=document.createElement('div'); s.className='sum'; s.innerHTML = `<div>${fmt(sumTable(tbl))}</div>`;
    card.appendChild(cells); card.appendChild(colTotals); card.appendChild(s); host.appendChild(card);
  });
  const ptr=nextEditablePointer(farmer);
  setTimeout(()=>{ const el=document.querySelector(`input[data-key="${ptr.ti}-${ptr.ci}"]`); if(el){ el.removeAttribute('disabled'); el.focus(); el.select(); } },30);
}

/* ===== Báº£ng 5Ã—5 ===== */
function ensureNextTable(){ const farmer=getActiveFarmer(); if(!farmer) return; const last=farmer.tables[farmer.tables.length-1]; if(isTableFull(last)) farmer.tables.push(newEmptyTable()); }
function nextEditablePointer(farmer){
  for(let ti=0; ti<farmer.tables.length; ti++){ const t=farmer.tables[ti];
    for(let col=0; col<5; col++){ for(let row=0; row<5; row++){
      const ci=row*5+col; if(t[ci]===null || typeof t[ci]!=='number') return {ti,ci};
    }}}
  ensureNextTable(); return {ti:farmer.tables.length-1, ci:0};
}
function isCellEnabled(farmer,ti,ci){ const ptr=nextEditablePointer(farmer); const already=typeof farmer.tables[ti][ci]==='number'; return already || (ti===ptr.ti && ci===ptr.ci); }
async function commitCellInput(farmer,ti,ci,raw,e,el){
  const mode = farmer.inputMode || 'lt3';
  const digits = String(raw||'').replace(/\D/g,'');
  const ptrNow = nextEditablePointer(farmer);
  const isCurrentPointer = (ti === ptrNow.ti && ci === ptrNow.ci);

  if (String(raw).trim() === '') { farmer.tables[ti][ci] = null; if(el) el.classList.remove('warn'); save(); return; }

  let v=null, commit=false, isOddGram=false;
  if(mode==='lt2'){ if(digits.length<2){ if(el) el.value=digits; return; } v = Number(digits.slice(0,2)); commit=true; }
  else if(mode==='lt3'){ if(digits.length<3){ if(el) el.value=digits; return; } const dec=Number(digits.slice(-1)); if(dec%2!==0) isOddGram=true; v = Number(digits.slice(0,2)) + dec/10; commit=true; }
  else if(mode==='ge3'){ if(digits.length<3){ if(el) el.value=digits; return; } v = Number(digits.slice(0,3)); commit=true; }
  else if(mode==='ge4'){ if(digits.length<4){ if(el) el.value=digits; return; } const dec=Number(digits.slice(-1)); if(dec%2!==0) isOddGram=true; v = Number(digits.slice(0,3)) + dec/10; commit=true; }
  else { const num=Number(String(raw||'').replace(',','.')); if(!isFinite(num)) return; v=num; commit=true; }

  // Giá»›i háº¡n biÃªn má»m Ä‘á»ƒ trÃ¡nh nháº­p nháº§m
  if (typeof v === 'number'){
    if (mode==='lt2' || mode==='lt3') v = Math.min(v, 99.9);
    if (mode==='ge3' || mode==='ge4') v = Math.min(v, 300.0);
  }

  if(el){ if(isOddGram) el.classList.add('warn'); else el.classList.remove('warn'); }

  farmer.tables[ti][ci]=v;
  if(el){ const hasDecimal=(mode==='lt3'||mode==='ge4'); el.value=(typeof v==='number')?(hasDecimal?v.toFixed(1):v):''; }

  if(commit){
    ensureNextTable(); save();
    if (isCurrentPointer){ const ptr = nextEditablePointer(getActiveFarmer()); const nx = document.querySelector(`input[data-key="${ptr.ti}-${ptr.ci}"]`); if(nx){ nx.removeAttribute('disabled'); nx.focus(); nx.select(); } }
    else if (el){ el.removeAttribute('disabled'); el.focus(); el.select(); }
  }
}

/* ===== Persistence & Boot ===== */
function migrateCreatedAt(){
  try{
    const now = Date.now();
    let i = 0;
    for (const gName of Object.keys(state.groups||{})){
      const grp = state.groups[gName];
      if (!grp.createdAt) grp.createdAt = now - (i++ * 1000);
      if (!grp.farmers) grp.farmers = {};
      let j = 0;
      for (const fName of Object.keys(grp.farmers)){
        const farmer = grp.farmers[fName];
        if (!farmer.createdAt) farmer.createdAt = now - (j++ * 1000);
      }
    }
  }catch(e){}
}

function resolveInitialView(){
  const hash = (location.hash||'').replace('#','');
  const allowed = ['groups','farmers','tables'];
  const init = allowed.includes(hash) ? hash : 'groups';
  state.view = init;
  // Äáº£m báº£o cÃ³ state ban Ä‘áº§u Ä‘Ãºng hash
  history.replaceState({view:init}, '', '#'+init);
}

function save(){ try{ localStorage.setItem(STORAGE_KEY,JSON.stringify(state)); }catch(e){} render(); }
function load(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(raw){ const parsed=JSON.parse(raw); if(parsed && parsed.groups) state=parsed; }
  }catch(e){}
  if (!state || typeof state!=='object') state={groups:{},activeGroup:'',activeFarmer:'',view:'groups'};
  if (!state.groups || typeof state.groups!=='object') state.groups={};
  migrateCreatedAt();
  // ğŸ” KHá»I Táº O THEO HASH (Ä‘Ã£ sá»­a)
  resolveInitialView();
  render();
}

/* ===== Global UI bindings ===== */
$('btnBack').addEventListener('click', navBack);
$('btnTools').addEventListener('click',()=>openSheet('appTools'));
$('btnSheetClose').addEventListener('click',closeSheet);
$('btnSheetCancel').addEventListener('click',closeSheet);
$('fabAddGroup').addEventListener('click',()=>openSheet('addGroup'));
$('fabAddFarmer').addEventListener('click',()=>openSheet('addFarmer'));

/* ===== Start ===== */
load();

/* Save khi rá»i trang */
window.addEventListener('pagehide', ()=> save());
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) save(); });

/* ===== PWA: SW + Kiá»ƒm tra cáº­p nháº­t + A2HS + Persistent Storage ===== */
(function(){
  // YÃŠU Cáº¦U PERSISTENT STORAGE
  (async () => {
    try {
      if (navigator.storage && navigator.storage.persist) {
        const isPersisted = await navigator.storage.persisted();
        if (!isPersisted) {
          const granted = await navigator.storage.persist();
          console.log('[storage] persist granted?', granted);
        } else {
          console.log('[storage] already persisted');
        }
      }
    } catch (e) { console.warn('persist error', e); }
  })();

function compareVersions(a, b){
	  const pa = String(a||'').replace(/^v/i,'').split('.').map(n=>Number(n)||0);
	  const pb = String(b||'').replace(/^v/i,'').split('.').map(n=>Number(n)||0);
	  const len = Math.max(pa.length, pb.length);
	  for (let i=0;i<len;i++){ const x=pa[i]||0, y=pb[i]||0; if(x>y) return 1; if(x<y) return -1; }
	  return 0;
	}
	
	async function checkForAppUpdate(){
	  try{
	    if (!navigator.onLine) return;
	
	    // Cáº­p nháº­t metadata SW (khÃ´ng auto-activate)
	    let reg = null;
	    if ('serviceWorker' in navigator){
	      reg = await navigator.serviceWorker.getRegistration('/can-lua/');
	      await reg?.update?.();
	    }
	
	    // Láº¥y version.json
	    const res = await fetch('/can-lua/version.json?ts=' + Date.now(), { cache: 'no-store' });
	    if (!res.ok) return;
	    const data = await res.json();
	
	    const serverVer = data.version || '';
	    const localVer  = (typeof APP_VERSION==='string') ? APP_VERSION : '0';
	
	    // Ghi chÃº cáº­p nháº­t (tÃ¹y chá»n)
	    let notesHTML = '';
	    if (Array.isArray(data.notes) && data.notes.length){
	      const items = data.notes.map(s => `<li>${escapeHtml(String(s))}</li>`).join('');
	      notesHTML = `<div style="margin-top:8px;padding:10px;border:1px dashed #e5e7eb;border-radius:12px;background:#fff7ed">
	        <div style="font-weight:800;margin-bottom:6px">Ná»™i dung cáº­p nháº­t</div>
	        <ul style="margin:0 0 0 18px;line-height:1.5">${items}</ul>
	      </div>`;
	    }
	    if (data.changelog_url){
	      notesHTML += `<div style="margin-top:8px;font-size:12px">
	        Xem chi tiáº¿t: <a href="${escapeHtml(String(data.changelog_url))}" target="_blank" rel="noopener noreferrer">Changelog</a>
	      </div>`;
	    }
	
	    // Chá»‰ há»i khi serverVer > localVer
	    if (serverVer && compareVersions(serverVer, localVer) > 0){
	      const ok = await openDialog({
	        title: 'CÃ³ phiÃªn báº£n má»›i',
	        message: `ÄÃ£ cÃ³ báº£n <b>${escapeHtml(serverVer)}</b> (báº¡n Ä‘ang dÃ¹ng <b>${escapeHtml(APP_VERSION)}</b>).${notesHTML}`,
	        okText: 'Táº£i ngay', cancelText: 'Äá»ƒ sau'
	      });
	      if (!ok) return; // ngÆ°á»i dÃ¹ng Ä‘á»ƒ sau
	
	      // NgÆ°á»i dÃ¹ng Ä‘á»“ng Ã½ â†’ yÃªu cáº§u SW má»›i kÃ­ch hoáº¡t rá»“i reload khi controller Ä‘á»•i
	      if ('serviceWorker' in navigator){
	        if (!reg) reg = await navigator.serviceWorker.getRegistration('/can-lua/');
	
	        let reloaded = false;
	        navigator.serviceWorker.addEventListener('controllerchange', () => {
	          if (!reloaded){ reloaded = true; location.reload(); }
	        }, { once:true });
	
	        const requestSkipWaiting = (r) => {
	          if (r?.waiting){ r.waiting.postMessage({ type: 'SKIP_WAITING' }); return true; }
	          return false;
	        };
	
	        // 1) Náº¿u Ä‘Ã£ cÃ³ SW á»Ÿ tráº¡ng thÃ¡i waiting â†’ skip ngay
	        if (!requestSkipWaiting(reg)){
	          // 2) ChÆ°a cÃ³ â†’ nghe updatefound, chá» installed rá»“i skip
	          reg?.addEventListener('updatefound', () => {
	            const sw = reg.installing;
	            if (!sw) return;
	            sw.addEventListener('statechange', () => {
	              if (sw.state === 'installed') requestSkipWaiting(reg);
	            });
	          });
	          // KÃ­ch quÃ¡ trÃ¬nh táº£i SW má»›i
	          await reg?.update?.();
	        }
	      } else {
	        // KhÃ´ng cÃ³ SW (trÃ¬nh duyá»‡t cÅ©) â†’ reload Ä‘Æ¡n giáº£n
	        location.reload();
	      }
	    }
	  }catch(e){
	    // im láº·ng
	  }
	}
	
	// ÄÄƒng kÃ½ SW + lá»‹ch kiá»ƒm tra (khÃ´ng tá»± cáº­p nháº­t náº¿u user chÆ°a Ä‘á»“ng Ã½)
	if ('serviceWorker' in navigator) {
	  window.addEventListener('load', () => {
	    navigator.serviceWorker
	      .register('/can-lua/service-worker.js', { scope: '/can-lua/' })
	      .then(reg=>{
	        checkForAppUpdate();
	        setInterval(() => { reg.update(); checkForAppUpdate(); }, 60 * 60 * 1000); // má»—i giá»
	      })
	      .catch(console.error);
	  });
	} else {
	  window.addEventListener('load', checkForAppUpdate);
	}
	
	document.addEventListener('visibilitychange', () => {
	  if (!document.hidden) checkForAppUpdate();
	});

  /* ===== Add to Home Screen (A2HS) ===== */
  (function(){
    let deferredPrompt=null;

    const isStandalone = () =>
      window.matchMedia('(display-mode: standalone)').matches ||
      window.navigator.standalone === true;

    const isIOS = () =>
      /iphone|ipad|ipod/i.test(navigator.userAgent) &&
      /safari/i.test(navigator.userAgent) &&
      !/crios|fxios|opios|EdgiOS/i.test(navigator.userAgent);

    // Äiá»u kiá»‡n cÃ i Ä‘áº·t: chÆ°a standalone vÃ  (Android cÃ³ beforeinstallprompt) hoáº·c (iOS Safari)
    function eligibleForInstall(){ return !isStandalone() && (Boolean(deferredPrompt) || isIOS()); }

    async function triggerInstall(){
      if (isIOS) {
        const standalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        if (!standalone){
          await showAlert('TrÃªn iPhone/iPad: má»Ÿ menu <b>Chia sáº» (â–¡â†‘)</b> â†’ <b>ThÃªm vÃ o MH chÃ­nh</b> Ä‘á»ƒ cÃ i á»©ng dá»¥ng dÃ¹ng offline.','HÆ°á»›ng dáº«n cÃ i Ä‘áº·t iOS');
          return;
        }
      }
      if (!deferredPrompt){
        await showAlert('TrÃ¬nh duyá»‡t chÆ°a sáºµn sÃ ng hiá»ƒn thá»‹ há»™p thoáº¡i cÃ i Ä‘áº·t. Vui lÃ²ng thá»­ láº¡i sau.');
        return;
      }
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      deferredPrompt = null;
      if (outcome === 'accepted'){ /* ngÆ°á»i dÃ¹ng Ä‘Ã£ cÃ i */ }
    }

    // Expose cho modal Tiá»‡n Ã­ch sá»­ dá»¥ng
    window.__a2hs = { eligible: eligibleForInstall, triggerInstall };

    // Hiá»ƒn thá»‹ nudge á»Ÿ trang chÃ­nh má»—i láº§n táº£i láº¡i (náº¿u Ä‘á»§ Ä‘iá»u kiá»‡n)
    async function maybeShowInstallNudge(){
      if (state.view !== 'groups') return; // chá»‰ nudge á»Ÿ trang chÃ­nh
      if (!eligibleForInstall()) return;
      const ok = await openDialog({
        title: 'Khuyáº¿n nghá»‹: CÃ i Ä‘áº·t á»©ng dá»¥ng',
        message: 'Báº¡n nÃªn <b>cÃ i Ä‘áº·t á»©ng dá»¥ng TÃ­nh cÃ¢n lÃºa</b> Ä‘á»ƒ dÃ¹ng nhanh hÆ¡n, lÆ°u trá»¯ dá»¯ liá»‡u an toÃ n vÃ  khÃ´ng cáº§n máº¡ng internet.',
        okText: 'CÃ i Ä‘áº·t ngay', cancelText: 'Äá»ƒ sau'
      });
      if (ok) await triggerInstall();
    }

    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt = e;
      setTimeout(maybeShowInstallNudge, 300);
    });

    window.addEventListener('load', ()=>{
      const isIOSUA = /iphone|ipad|ipod/i.test(navigator.userAgent) && /safari/i.test(navigator.userAgent) && !/crios|fxios|opios|EdgiOS/i.test(navigator.userAgent);
      const standalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
      if (isIOSUA && !standalone){
        setTimeout(maybeShowInstallNudge, 600);
      }
    });

    window.addEventListener('appinstalled', ()=>{ deferredPrompt=null; });
  })();
})();
</script>
</body>
</html>